name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Build Application
      run: |
        chmod +x Scripts/build.sh
        ./Scripts/build.sh
        
    - name: Verify Build Output
      run: |
        ls -la build/Release/
        if [ ! -d "build/Release/Buatsaver.app" ]; then
          echo "Error: Buatsaver.app was not built successfully"
          exit 1
        fi
        if [ ! -d "build/Release/BuatsaverScreensaver.saver" ]; then
          echo "Error: BuatsaverScreensaver.saver was not built successfully"
          exit 1
        fi
        
    - name: Create DMG
      if: github.ref == 'refs/heads/main'
      run: |
        chmod +x Scripts/create_dmg.sh
        ./Scripts/create_dmg.sh
        
    - name: Archive Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: buatsaver-build
        path: |
          build/Release/Buatsaver.app
          build/Release/BuatsaverScreensaver.saver
        retention-days: 30
        
    - name: Archive DMG
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: buatsaver-dmg
        path: Buatsaver-*.dmg
        retention-days: 30