name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest

    env:
      VERSION: ${{ github.ref_name }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Extract version (strip v)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        VERSION="${VERSION#v}"   # strip leading v
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Build Application
      run: |
        chmod +x Scripts/build.sh
        ./Scripts/build.sh
        
    - name: Verify Build Output
      run: |
        ls -la build/Release/
        if [ ! -d "build/Release/Buatsaver.app" ]; then
          echo "Error: Buatsaver.app was not built successfully"
          exit 1
        fi
        if [ ! -d "build/Release/BuatsaverScreensaver.saver" ]; then
          echo "Error: Screensaver not built!"
          exit 1
        fi

    - name: Create DMG
      run: |
        chmod +x Scripts/create_dmg.sh
        VERSION=${{ env.VERSION }} ./Scripts/create_dmg.sh
        # Expect your script to output Buatsaver-$VERSION.dmg
        
    - name: Archive Build Artifacts (optional)
      uses: actions/upload-artifact@v4
      with:
        name: buatsaver-build
        path: |
          build/Release/Buatsaver.app
        retention-days: 30
        
    - name: Archive DMG (optional)
      uses: actions/upload-artifact@v4
      with:
        name: buatsaver-dmg
        path: Buatsaver-*.dmg
        retention-days: 30

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "${{ github.ref_name }}"
        release_name: "Release ${{ env.VERSION }}"
        draft: false
        prerelease: false
        files: |
          Buatsaver-${{ env.VERSION }}.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_RELEASE }}